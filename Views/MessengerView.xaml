<UserControl x:Class="M_A_G_A.Views.MessengerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:md="clr-namespace:M_A_G_A.Helpers">
    <Grid Background="{StaticResource BgBrush}">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="280"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <!-- ═══════════════ LEFT: Contacts Panel ═══════════════ -->
        <Grid Grid.Column="0" Background="{StaticResource SurfaceBrush}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- My profile header -->
            <Border Grid.Row="0" Padding="16,20,16,16"
                    BorderBrush="{StaticResource BorderBrush2}" BorderThickness="0,0,0,1">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- My avatar -->
                    <Grid Grid.Column="0" Width="46" Height="46" Margin="0,0,12,0">
                        <Border CornerRadius="23" Background="{StaticResource Surface2Brush}">
                            <TextBlock Text="?" FontSize="20" Foreground="{StaticResource TextSecBrush}"
                                       HorizontalAlignment="Center" VerticalAlignment="Center"
                                       Visibility="{Binding MyAvatar, Converter={StaticResource NullToVis}, ConverterParameter=invert}"/>
                        </Border>
                        <Border CornerRadius="23" Width="46" Height="46"
                                Visibility="{Binding MyAvatar, Converter={StaticResource NullToVis}}">
                            <Border.Background>
                                <ImageBrush ImageSource="{Binding MyAvatar, Converter={StaticResource BytesToImage}}"
                                            Stretch="UniformToFill"/>
                            </Border.Background>
                        </Border>
                        <Ellipse Width="12" Height="12" Fill="{StaticResource OnlineBrush}"
                                 HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                 Stroke="{StaticResource SurfaceBrush}" StrokeThickness="2"/>
                    </Grid>

                    <!-- My name -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock Text="{Binding MyName}" FontSize="15" FontWeight="SemiBold"
                                   TextTrimming="CharacterEllipsis"/>
                        <TextBlock FontSize="10" Foreground="{StaticResource TextSecBrush}"
                                   Text="{Binding MyIPv4, Mode=OneWay}" TextTrimming="CharacterEllipsis"/>
                    </StackPanel>

                    <!-- Edit avatar -->
                    <Button Grid.Column="2" Style="{StaticResource IconButton}"
                            Command="{Binding PickAvatarCommand}" Padding="6"
                            ToolTip="Сменить аватарку">
                        <TextBlock Text="✎" FontSize="14" Foreground="{StaticResource TextSecBrush}"/>
                    </Button>

                    <!-- Settings -->
                    <Button Grid.Column="3" Style="{StaticResource IconButton}"
                            Command="{Binding ToggleSettingsCommand}" Padding="6"
                            ToolTip="Настройки">
                        <TextBlock Text="⚙" FontSize="14" Foreground="{StaticResource TextSecBrush}"/>
                    </Button>
                </Grid>
            </Border>

            <!-- Search -->
            <Border Grid.Row="1" Padding="12,10">
                <Grid>
                    <TextBox Style="{StaticResource ModernTextBox}"
                             Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}"
                             Padding="36,10,14,10" FontSize="13"/>
                    <TextBlock Text="🔍" FontSize="13" VerticalAlignment="Center"
                               Margin="12,0,0,0" IsHitTestVisible="False"/>
                </Grid>
            </Border>

            <!-- Contacts list -->
            <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto"
                          HorizontalScrollBarVisibility="Disabled">
                <StackPanel>
                    <TextBlock Text="ПОЛЬЗОВАТЕЛИ В СЕТИ"
                               FontSize="10" Foreground="{StaticResource TextSecBrush}"
                               FontWeight="SemiBold" Margin="16,8,16,4"/>

                    <ItemsControl ItemsSource="{Binding FilteredContacts}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Style="{StaticResource IconButton}" Padding="12,10"
                                        Command="{Binding DataContext.SelectContactCommand,
                                                  RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                        CommandParameter="{Binding}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid Grid.Column="0" Width="44" Height="44" Margin="0,0,12,0">
                                            <Border CornerRadius="22" Background="{StaticResource Surface3Brush}">
                                                <TextBlock Text="{Binding Username[0]}" FontSize="18"
                                                           HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                            <Border CornerRadius="22" Width="44" Height="44"
                                                    Visibility="{Binding AvatarBytes, Converter={StaticResource NullToVis}}">
                                                <Border.Background>
                                                    <ImageBrush ImageSource="{Binding AvatarBytes, Converter={StaticResource BytesToImage}}"
                                                                Stretch="UniformToFill"/>
                                                </Border.Background>
                                            </Border>
                                            <Ellipse Width="11" Height="11"
                                                     Fill="{Binding IsOnline, Converter={StaticResource BoolToColor}}"
                                                     HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                                     Stroke="{StaticResource SurfaceBrush}" StrokeThickness="2"/>
                                        </Grid>
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding Username}" FontSize="14" FontWeight="Medium"
                                                       TextTrimming="CharacterEllipsis"/>
                                            <TextBlock FontSize="11" Foreground="{StaticResource TextSecBrush}"
                                                       TextTrimming="CharacterEllipsis">
                                                <TextBlock.Text>
                                                    <MultiBinding StringFormat="{}{0} · {1}">
                                                        <Binding Path="StatusText"/>
                                                        <Binding Path="IpAddress"/>
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </StackPanel>
                                    </Grid>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <StackPanel Visibility="{Binding FilteredContacts.Count,
                                Converter={StaticResource BoolToVis}, ConverterParameter=invert}"
                                HorizontalAlignment="Center" Margin="20,40">
                        <TextBlock Text="📡" FontSize="32" HorizontalAlignment="Center" Margin="0,0,0,8"/>
                        <TextBlock Text="Поиск пользователей..." FontSize="13"
                                   Foreground="{StaticResource TextSecBrush}"
                                   HorizontalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>

            <!-- Settings panel (inline) -->
            <Border Grid.Row="3"
                    Visibility="{Binding ShowSettings, Converter={StaticResource BoolToVis}}"
                    Background="{StaticResource Surface2Brush}"
                    BorderBrush="{StaticResource BorderBrush2}" BorderThickness="0,1,0,0"
                    Padding="16,14">
                <StackPanel>
                    <TextBlock Text="НАСТРОЙКИ" FontSize="10" FontWeight="SemiBold"
                               Foreground="{StaticResource TextSecBrush}" Margin="0,0,0,10"/>

                    <!-- Auto-start -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                        <CheckBox IsChecked="{Binding AutoStart}" VerticalAlignment="Center"
                                  Foreground="White" Cursor="Hand"/>
                        <TextBlock Text=" Автозапуск при входе в систему"
                                   FontSize="12" VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Identity info -->
                    <TextBlock Text="МОЙ КОМПЬЮТЕР" FontSize="10" FontWeight="SemiBold"
                               Foreground="{StaticResource TextSecBrush}" Margin="0,6,0,6"/>
                    <TextBlock FontSize="11" TextWrapping="Wrap" Foreground="{StaticResource TextSecBrush}">
                        <Run Text="MAC: "/>
                        <Run Text="{Binding MyMacAddress, Mode=OneWay}" Foreground="White"/>
                    </TextBlock>
                    <TextBlock FontSize="11" TextWrapping="Wrap" Foreground="{StaticResource TextSecBrush}">
                        <Run Text="Host: "/>
                        <Run Text="{Binding MyHostname, Mode=OneWay}" Foreground="White"/>
                    </TextBlock>
                    <TextBlock FontSize="11" TextWrapping="Wrap" Foreground="{StaticResource TextSecBrush}">
                        <Run Text="IPv4: "/>
                        <Run Text="{Binding MyIPv4, Mode=OneWay}" Foreground="White"/>
                    </TextBlock>
                    <TextBlock FontSize="11" TextWrapping="Wrap" Foreground="{StaticResource TextSecBrush}">
                        <Run Text="IPv6: "/>
                        <Run Text="{Binding MyIPv6, Mode=OneWay}" Foreground="White"/>
                    </TextBlock>

                    <!-- Export/Import -->
                    <StackPanel Orientation="Horizontal" Margin="0,12,0,0">
                        <Button Content="Экспорт истории" Style="{StaticResource IconButton}"
                                Command="{Binding ExportHistoryCommand}"
                                Background="{StaticResource Surface3Brush}"
                                Padding="10,6" FontSize="11" Margin="0,0,6,0"/>
                        <Button Content="Импорт" Style="{StaticResource IconButton}"
                                Command="{Binding ImportHistoryCommand}"
                                Background="{StaticResource Surface3Brush}"
                                Padding="10,6" FontSize="11"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <!-- ═══════════════ CENTER: Chat Panel ═══════════════ -->
        <Grid Grid.Column="1">

            <!-- Empty state -->
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                        Visibility="{Binding HasSelectedContact, Converter={StaticResource BoolToVis}, ConverterParameter=invert}">
                <TextBlock Text="💬" FontSize="56" HorizontalAlignment="Center" Margin="0,0,0,16"/>
                <TextBlock Text="Выберите собеседника" FontSize="18" FontWeight="SemiBold"
                           HorizontalAlignment="Center" Margin="0,0,0,8"/>
                <TextBlock Text="Пользователи в локальной сети появятся в списке слева"
                           FontSize="13" Foreground="{StaticResource TextSecBrush}"
                           HorizontalAlignment="Center" TextAlignment="Center" LineHeight="22"/>
            </StackPanel>

            <!-- Chat area -->
            <Grid Visibility="{Binding HasSelectedContact, Converter={StaticResource BoolToVis}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Chat header -->
                <Border Grid.Row="0" Padding="20,14"
                        Background="{StaticResource SurfaceBrush}"
                        BorderBrush="{StaticResource BorderBrush2}" BorderThickness="0,0,0,1">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid Width="40" Height="40" Margin="0,0,14,0">
                            <Border CornerRadius="20" Background="{StaticResource Surface3Brush}">
                                <TextBlock Text="{Binding SelectedContact.Username[0]}"
                                           FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                            <Border CornerRadius="20" Width="40" Height="40"
                                    Visibility="{Binding SelectedContact.AvatarBytes, Converter={StaticResource NullToVis}}">
                                <Border.Background>
                                    <ImageBrush ImageSource="{Binding SelectedContact.AvatarBytes, Converter={StaticResource BytesToImage}}"
                                                Stretch="UniformToFill"/>
                                </Border.Background>
                            </Border>
                        </Grid>
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="{Binding SelectedContact.Username}" FontSize="15" FontWeight="SemiBold"/>
                            <StackPanel Orientation="Horizontal">
                                <Ellipse Width="7" Height="7" Margin="0,0,5,0" VerticalAlignment="Center"
                                         Fill="{Binding SelectedContact.IsOnline, Converter={StaticResource BoolToColor}}"/>
                                <TextBlock Text="{Binding SelectedContact.StatusText}"
                                           FontSize="12" Foreground="{StaticResource TextSecBrush}"/>
                            </StackPanel>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Messages list -->
                <ScrollViewer Grid.Row="1" x:Name="MsgScroll" Padding="16,8"
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled"
                              ScrollChanged="MsgScroll_ScrollChanged">
                    <ItemsControl ItemsSource="{Binding CurrentMessages}" x:Name="MsgList">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,4">

                                    <!-- ── TEXT (markdown) ── -->
                                    <Border Visibility="{Binding IsText, Converter={StaticResource BoolToVis}}"
                                            HorizontalAlignment="{Binding IsSentByMe, Converter={StaticResource MsgAlign}, ConverterParameter=HorizontalAlignment}"
                                            Background="{Binding IsSentByMe, Converter={StaticResource BubbleColor}}"
                                            CornerRadius="18" Padding="14,10" MaxWidth="480">
                                        <StackPanel>
                                            <TextBlock TextWrapping="Wrap" FontSize="14" LineHeight="22"
                                                       Foreground="{Binding IsSentByMe, Converter={StaticResource BubbleTextColor}}"
                                                       md:MarkdownText.Text="{Binding Content}"/>
                                            <TextBlock Text="{Binding TimeFormatted}" FontSize="10"
                                                       Foreground="{Binding IsSentByMe, Converter={StaticResource BubbleTextColor}}"
                                                       Opacity="0.5" HorizontalAlignment="Right" Margin="0,4,0,0"/>
                                        </StackPanel>
                                    </Border>

                                    <!-- ── VOICE ── -->
                                    <Border Visibility="{Binding IsVoice, Converter={StaticResource BoolToVis}}"
                                            HorizontalAlignment="{Binding IsSentByMe, Converter={StaticResource MsgAlign}, ConverterParameter=HorizontalAlignment}"
                                            Background="{Binding IsSentByMe, Converter={StaticResource BubbleColor}}"
                                            CornerRadius="18" Padding="12,10" MinWidth="200">
                                        <StackPanel Orientation="Horizontal">
                                            <Button Style="{StaticResource IconButton}"
                                                    Command="{Binding DataContext.PlayVoiceCommand,
                                                              RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                    CommandParameter="{Binding}"
                                                    Width="38" Height="38" Padding="0"
                                                    Background="{StaticResource Surface3Brush}">
                                                <TextBlock Text="{Binding PlayButtonLabel}" FontSize="16"
                                                           Foreground="{Binding IsSentByMe, Converter={StaticResource BubbleTextColor}}"/>
                                            </Button>
                                            <StackPanel Margin="10,0,0,0" VerticalAlignment="Center">
                                                <TextBlock Text="Голосовое сообщение"
                                                           Foreground="{Binding IsSentByMe, Converter={StaticResource BubbleTextColor}}"
                                                           FontSize="13" FontWeight="Medium"/>
                                                <TextBlock Text="{Binding TimeFormatted}" FontSize="10"
                                                           Foreground="{Binding IsSentByMe, Converter={StaticResource BubbleTextColor}}"
                                                           Opacity="0.5"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>

                                    <!-- ── IMAGE ── -->
                                    <Border Visibility="{Binding IsImage, Converter={StaticResource BoolToVis}}"
                                            HorizontalAlignment="{Binding IsSentByMe, Converter={StaticResource MsgAlign}, ConverterParameter=HorizontalAlignment}"
                                            Background="{Binding IsSentByMe, Converter={StaticResource BubbleColor}}"
                                            CornerRadius="14" Padding="6" MaxWidth="380">
                                        <StackPanel>
                                            <Border CornerRadius="10" ClipToBounds="True">
                                                <Image Source="{Binding ImageBytes, Converter={StaticResource BytesToImage}}"
                                                       MaxHeight="300" Stretch="Uniform"/>
                                            </Border>
                                            <TextBlock Text="{Binding TimeFormatted}" FontSize="10"
                                                       Foreground="{Binding IsSentByMe, Converter={StaticResource BubbleTextColor}}"
                                                       Opacity="0.5" HorizontalAlignment="Right" Margin="4,4,4,0"/>
                                        </StackPanel>
                                    </Border>

                                    <!-- ── FILE ── -->
                                    <Border Visibility="{Binding IsFile, Converter={StaticResource BoolToVis}}"
                                            HorizontalAlignment="{Binding IsSentByMe, Converter={StaticResource MsgAlign}, ConverterParameter=HorizontalAlignment}"
                                            Background="{Binding IsSentByMe, Converter={StaticResource BubbleColor}}"
                                            CornerRadius="14" Padding="14,10" MinWidth="200" MaxWidth="340">
                                        <StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                                <TextBlock Text="📁" FontSize="22" Margin="0,0,10,0" VerticalAlignment="Center"/>
                                                <StackPanel VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding FileName}" FontSize="13" FontWeight="Medium"
                                                               Foreground="{Binding IsSentByMe, Converter={StaticResource BubbleTextColor}}"
                                                               TextTrimming="CharacterEllipsis" MaxWidth="200"/>
                                                    <TextBlock Text="{Binding TimeFormatted}" FontSize="10"
                                                               Foreground="{Binding IsSentByMe, Converter={StaticResource BubbleTextColor}}"
                                                               Opacity="0.5"/>
                                                </StackPanel>
                                            </StackPanel>
                                            <!-- Save button (only for received files) -->
                                            <Button Style="{StaticResource IconButton}"
                                                    Visibility="{Binding IsSentByMe, Converter={StaticResource BoolToVis}, ConverterParameter=invert}"
                                                    Command="{Binding DataContext.SaveFileCommand,
                                                              RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                    CommandParameter="{Binding}"
                                                    Background="{StaticResource Surface3Brush}"
                                                    Padding="8,4" FontSize="12" HorizontalAlignment="Left">
                                                <TextBlock Text="💾  Сохранить"/>
                                            </Button>
                                        </StackPanel>
                                    </Border>

                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- Input area -->
                <Border Grid.Row="2" Padding="12,10"
                        Background="{StaticResource SurfaceBrush}"
                        BorderBrush="{StaticResource BorderBrush2}" BorderThickness="0,1,0,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Attach image -->
                        <Button Grid.Column="0" Style="{StaticResource IconButton}"
                                Command="{Binding SendImageCommand}"
                                Width="38" Height="38" Padding="0"
                                ToolTip="Отправить изображение" Margin="0,0,4,0">
                            <TextBlock Text="🖼" FontSize="17"/>
                        </Button>

                        <!-- Attach file -->
                        <Button Grid.Column="1" Style="{StaticResource IconButton}"
                                Command="{Binding SendFileCommand}"
                                Width="38" Height="38" Padding="0"
                                ToolTip="Отправить файл" Margin="0,0,4,0">
                            <TextBlock Text="📎" FontSize="17"/>
                        </Button>

                        <!-- Voice file -->
                        <Button Grid.Column="2" Style="{StaticResource IconButton}"
                                Command="{Binding SendVoiceFileCommand}"
                                Width="38" Height="38" Padding="0"
                                ToolTip="Отправить аудиофайл" Margin="0,0,8,0">
                            <TextBlock Text="🎵" FontSize="17"/>
                        </Button>

                        <!-- Text input (supports markdown, Shift+Enter = newline) -->
                        <TextBox Grid.Column="3" Style="{StaticResource ModernTextBox}"
                                 Text="{Binding MessageInput, UpdateSourceTrigger=PropertyChanged}"
                                 Padding="14,10" FontSize="14"
                                 KeyDown="MessageInput_KeyDown"
                                 AcceptsReturn="False"
                                 ToolTip="Markdown: **жирный** *курсив* `код` [ссылка](url) ~~зачёркнутый~~"/>

                        <!-- Voice record / stop -->
                        <Button Grid.Column="4" Style="{StaticResource IconButton}"
                                Command="{Binding StartVoiceCommand}"
                                Margin="8,0,0,0" Width="42" Height="42" Padding="0"
                                Visibility="{Binding IsRecording, Converter={StaticResource BoolToVis}, ConverterParameter=invert}"
                                ToolTip="Записать голосовое">
                            <TextBlock Text="🎙" FontSize="20"/>
                        </Button>
                        <Button Grid.Column="4" Style="{StaticResource IconButton}"
                                Command="{Binding StopVoiceCommand}"
                                Margin="8,0,0,0" Width="42" Height="42" Padding="0"
                                Visibility="{Binding IsRecording, Converter={StaticResource BoolToVis}}"
                                Background="#CC0000">
                            <TextBlock Text="⏹" FontSize="20"/>
                        </Button>

                        <!-- Send -->
                        <Button Grid.Column="5" Style="{StaticResource IconButton}"
                                Command="{Binding SendTextCommand}"
                                Margin="4,0,0,0" Width="42" Height="42" Padding="0">
                            <TextBlock Text="➤" FontSize="20" Foreground="White"/>
                        </Button>
                    </Grid>
                </Border>
            </Grid>
        </Grid>

        <!-- ═══════════════ RIGHT: User Info Panel ════════════════ -->
        <Border Grid.Column="2" Width="220" Background="{StaticResource SurfaceBrush}"
                BorderBrush="{StaticResource BorderBrush2}" BorderThickness="1,0,0,0"
                Visibility="{Binding HasSelectedContact, Converter={StaticResource BoolToVis}}">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <Border Padding="20,24">
                    <StackPanel>
                        <!-- Large avatar -->
                        <Grid Width="80" Height="80" HorizontalAlignment="Center" Margin="0,0,0,16">
                            <Border CornerRadius="40" Background="{StaticResource Surface3Brush}" Width="80" Height="80">
                                <TextBlock Text="{Binding SelectedContact.Username[0]}" FontSize="32"
                                           HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                            <Border CornerRadius="40" Width="80" Height="80"
                                    Visibility="{Binding SelectedContact.AvatarBytes, Converter={StaticResource NullToVis}}">
                                <Border.Background>
                                    <ImageBrush ImageSource="{Binding SelectedContact.AvatarBytes, Converter={StaticResource BytesToImage}}"
                                                Stretch="UniformToFill"/>
                                </Border.Background>
                            </Border>
                            <Ellipse Width="16" Height="16" HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                     Fill="{Binding SelectedContact.IsOnline, Converter={StaticResource BoolToColor}}"
                                     Stroke="{StaticResource SurfaceBrush}" StrokeThickness="3"/>
                        </Grid>

                        <TextBlock Text="{Binding SelectedContact.Username}"
                                   FontSize="16" FontWeight="SemiBold"
                                   HorizontalAlignment="Center" TextWrapping="Wrap"
                                   TextAlignment="Center" Margin="0,0,0,6"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,0,0,20">
                            <Ellipse Width="8" Height="8" VerticalAlignment="Center" Margin="0,0,6,0"
                                     Fill="{Binding SelectedContact.IsOnline, Converter={StaticResource BoolToColor}}"/>
                            <TextBlock Text="{Binding SelectedContact.StatusText}"
                                       FontSize="12" Foreground="{StaticResource TextSecBrush}"/>
                        </StackPanel>

                        <Rectangle Height="1" Fill="{StaticResource BorderBrush2}" Margin="0,0,0,20"/>
                        <TextBlock Text="И Н Ф О Р М А Ц И Я" FontSize="10" FontWeight="SemiBold"
                                   Foreground="{StaticResource TextSecBrush}" Margin="0,0,0,14"/>

                        <!-- hostname -->
                        <StackPanel Margin="0,0,0,10">
                            <TextBlock Text="Hostname" FontSize="11" Foreground="{StaticResource TextSecBrush}" Margin="0,0,0,2"/>
                            <TextBlock Text="{Binding SelectedContact.Hostname}" FontSize="12" TextWrapping="Wrap"/>
                        </StackPanel>

                        <!-- MAC -->
                        <StackPanel Margin="0,0,0,10">
                            <TextBlock Text="MAC-адрес" FontSize="11" Foreground="{StaticResource TextSecBrush}" Margin="0,0,0,2"/>
                            <TextBlock Text="{Binding SelectedContact.MacAddress}" FontSize="12" TextWrapping="Wrap"
                                       FontFamily="Consolas"/>
                        </StackPanel>

                        <!-- IPv4 -->
                        <StackPanel Margin="0,0,0,10">
                            <TextBlock Text="IPv4" FontSize="11" Foreground="{StaticResource TextSecBrush}" Margin="0,0,0,2"/>
                            <TextBlock Text="{Binding SelectedContact.IpAddress}" FontSize="12" TextWrapping="Wrap"/>
                        </StackPanel>

                        <!-- IPv6 -->
                        <StackPanel Margin="0,0,0,10"
                                    Visibility="{Binding SelectedContact.IPv6, Converter={StaticResource NullToVis}}">
                            <TextBlock Text="IPv6" FontSize="11" Foreground="{StaticResource TextSecBrush}" Margin="0,0,0,2"/>
                            <TextBlock Text="{Binding SelectedContact.IPv6}" FontSize="11" TextWrapping="Wrap"
                                       FontFamily="Consolas"/>
                        </StackPanel>

                        <!-- Port -->
                        <StackPanel Margin="0,0,0,10">
                            <TextBlock Text="Порт TCP" FontSize="11" Foreground="{StaticResource TextSecBrush}" Margin="0,0,0,2"/>
                            <TextBlock Text="{Binding SelectedContact.TcpPort}" FontSize="12"/>
                        </StackPanel>

                        <StackPanel Margin="0,0,0,10">
                            <TextBlock Text="Последняя активность" FontSize="11" Foreground="{StaticResource TextSecBrush}" Margin="0,0,0,2"/>
                            <TextBlock Text="{Binding SelectedContact.StatusText}" FontSize="12" TextWrapping="Wrap"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </ScrollViewer>
        </Border>
    </Grid>
</UserControl>